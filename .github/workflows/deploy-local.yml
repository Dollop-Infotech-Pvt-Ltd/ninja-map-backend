name: Deploy Spring Boot to Cloudways (via Cloudflare Tunnel)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_USERNAME: ${{ secrets.LOCAL_SSH_USERNAME }}
      REMOTE_PATH: ${{ secrets.LOCAL_REMOTE_PATH }}
      CF_TUNNEL_NAME: ${{ secrets.CF_TUNNEL_NAME }}
      CF_CERT_PEM: ${{ secrets.CF_CERT_PEM }}
      SSH_HOST: ${{ secrets.CF_HOST_URL }}
      APP_NAME: ninja-map

    steps:
    # 1Ô∏è‚É£ Checkout code
    - name: üì• Checkout code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Setup Java
    - name: ‚òï Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3Ô∏è‚É£ Build Spring Boot app
    - name: üõ†Ô∏è Build Spring Boot app
      run: mvn clean package -DskipTests

    # 4Ô∏è‚É£ Prepare JAR
    - name: üì¶ Prepare JAR
      run: |
        mkdir -p deployment
        cp target/*.jar deployment/${APP_NAME}.jar

    # 5Ô∏è‚É£ Install cloudflared
    - name: üåâ Install cloudflared
      run: |
        curl -fsSL https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb -o cloudflared.deb
        sudo dpkg -i cloudflared.deb

    # 6Ô∏è‚É£ Setup SSH key
    - name: üîë Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    # 7Ô∏è‚É£ Configure SSH via Cloudflare Tunnel
    - name: üîê Configure SSH (Cloudflare Tunnel)
      run: |
        mkdir -p ~/.ssh

        cat <<EOF > ~/.ssh/config
        Host cf-server
          HostName $SSH_HOST
          User $SSH_USERNAME
          ProxyCommand cloudflared access ssh --hostname %h
          StrictHostKeyChecking no
        EOF

        chmod 600 ~/.ssh/config

    # 8Ô∏è‚É£ Verify SSH connectivity
    - name: üîç Verify SSH connection
      run: |
        ssh cf-server "echo 'Connected via Cloudflare Tunnel'"

    # 9Ô∏è‚É£ Upload JAR safely
    - name: üöÄ Upload new JAR
      run: |
        scp deployment/${APP_NAME}.jar \
          cf-server:$REMOTE_PATH/${APP_NAME}.jar.new

    # üîü Replace JAR atomically
    - name: üîÅ Replace JAR
      run: |
        ssh cf-server "
          mv $REMOTE_PATH/${APP_NAME}.jar.new $REMOTE_PATH/${APP_NAME}.jar
        "

    # 1Ô∏è‚É£1Ô∏è‚É£ Restart service
    - name: üîÑ Restart Spring Boot service
      run: |
        ssh cf-server "
          sudo systemctl daemon-reload && \
          sudo systemctl restart ${APP_NAME}.service && \
          sudo systemctl status ${APP_NAME}.service --no-pager
        "
