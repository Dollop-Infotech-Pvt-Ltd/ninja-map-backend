name: Deploy Spring Boot to Cloudways (via Cloudflare Tunnel)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_USERNAME: ${{ secrets.LOCAL_SSH_USERNAME }}
      REMOTE_PATH: ${{ secrets.LOCAL_REMOTE_PATH }}
      CF_TUNNEL_NAME: ${{ secrets.CF_TUNNEL_NAME }}
      CF_CERT_PEM: ${{ secrets.CF_CERT_PEM }}
      SSH_HOST: ${{ secrets.CF_HOST_URL }}
      APP_NAME: ninja-map

    steps:
    # 1ï¸âƒ£ Checkout code
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    # 2ï¸âƒ£ Setup Java
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3ï¸âƒ£ Build Spring Boot app
    - name: ğŸ› ï¸ Build Spring Boot app
      run: mvn clean package -DskipTests

    # 4ï¸âƒ£ Prepare JAR
    - name: ğŸ“¦ Prepare JAR
      run: |
        mkdir -p deployment
        cp target/*.jar deployment/${APP_NAME}.jar

    # 5ï¸âƒ£ Install cloudflared
    - name: ğŸŒ‰ Install cloudflared
      run: |
        curl -fsSL https://github.com/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb -o cloudflared.deb
        sudo dpkg -i cloudflared.deb

    # 6ï¸âƒ£ Setup SSH key
    - name: ğŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.LOCAL_SSH_PRIVATE_KEY }}

    # 7ï¸âƒ£ Configure SSH via Cloudflare Tunnel
    - name: ğŸ” Configure SSH (Cloudflare Tunnel)
      run: |
        mkdir -p ~/.ssh
        cat <<EOF > ~/.ssh/config
        Host cf-server
          HostName $SSH_HOST
          User $SSH_USERNAME
          ProxyCommand cloudflared access ssh --hostname %h
          StrictHostKeyChecking no
        EOF
        chmod 600 ~/.ssh/config

    # 8ï¸âƒ£ Verify SSH connectivity
    - name: ğŸ” Verify SSH connection
      run: |
        ssh cf-server "echo 'Connected via Cloudflare Tunnel'"

    # âœ… 8.5ï¸âƒ£ Ensure remote directory exists (FIX)
    - name: ğŸ—‚ï¸ Ensure remote directory exists
      run: |
        ssh cf-server "mkdir -p '$REMOTE_PATH'"

    # 9ï¸âƒ£ Upload JAR safely
    - name: ğŸš€ Upload new JAR
      run: |
        scp deployment/${APP_NAME}.jar \
          cf-server:$REMOTE_PATH/${APP_NAME}.jar.new

    # ğŸ”Ÿ Replace JAR atomically
    - name: ğŸ” Replace JAR
      run: |
        ssh cf-server "
          mv $REMOTE_PATH/${APP_NAME}.jar.new $REMOTE_PATH/${APP_NAME}.jar
        "

    # 1ï¸âƒ£1ï¸âƒ£ Restart service
    - name: ğŸ”„ Restart Spring Boot service
      run: |
        ssh cf-server "
          sudo systemctl daemon-reload && \
          sudo systemctl restart ${APP_NAME}.service && \
          sudo systemctl status ${APP_NAME}.service --no-pager
        "
