name: Deploy Spring Boot App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
      REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
      APP_NAME: ninja-map
      
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: â˜• Set up JDK
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ğŸ› ï¸ Build Spring Boot app
      run: mvn clean package -DskipTests

    - name: ğŸ“¦ Prepare deployment artifact
      run: |
        mkdir -p deployment
        cp target/*.jar deployment/${APP_NAME}.jar

    - name: ğŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: ğŸ“ Ensure remote directory exists
      run: |
        ssh -o StrictHostKeyChecking=no $SSH_USERNAME@$SSH_HOST \
        "mkdir -p $REMOTE_PATH"

    - name: ğŸ§¹ Remove existing JAR
      run: |
        ssh -o StrictHostKeyChecking=no $SSH_USERNAME@$SSH_HOST \
        "rm -f $REMOTE_PATH/${APP_NAME}.jar"

    - name: ğŸš€ Upload new JAR
      run: |
        scp -o StrictHostKeyChecking=no deployment/${APP_NAME}.jar \
        $SSH_USERNAME@$SSH_HOST:$REMOTE_PATH/

    - name: ğŸ” Restart application service
      run: |
        ssh -o StrictHostKeyChecking=no $SSH_USERNAME@$SSH_HOST \
        "sudo systemctl restart ${APP_NAME}.service"
